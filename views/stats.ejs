<%- include('header') %>

<style>
  .hero-card {
    background: linear-gradient(135deg, #1a365d 0%, #2d4a6f 100%);
    color: white;
    border: none;
  }
  .hero-card .card-title {
    font-size: 2rem;
    font-weight: 700;
  }
  .hero-card .lead {
    font-size: 1.1rem;
    opacity: 0.9;
  }
  .stat-card {
    border: none;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
    border-radius: 12px;
    overflow: hidden;
  }
  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  }
  .stat-card .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--brand-primary);
  }
  .stat-card .stat-label {
    font-size: 1rem;
    color: #6c757d;
  }
  .stat-card .stat-icon {
    font-size: 2.5rem;
    color: var(--brand-secondary);
  }
  .chart-card {
    border: none;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    border-radius: 12px;
    overflow: hidden;
  }
  .chart-card .card-body canvas {
    min-height: 300px;
    max-height: 400px;
  }
  .chart-card .card-header {
    background: linear-gradient(135deg, var(--brand-primary) 0%, #2d4a6f 100%);
    color: white;
    font-weight: 600;
    padding: 1rem 1.25rem;
  }
  .chart-card .card-header i {
    color: var(--brand-secondary);
    margin-right: 0.5rem;
  }
  .clickable-row:hover td {
    background-color: #e9ecef !important;
  }
  .clickable-row:focus {
    outline: 2px solid var(--brand-secondary);
    outline-offset: -2px;
  }

  /* Mobile Responsive Styles */
  @media (max-width: 767.98px) {
    /* Hero card - smaller text */
    .hero-card .card-title {
      font-size: 1.5rem;
    }
    .hero-card .lead {
      font-size: 0.95rem;
    }
    .hero-card .card-body {
      padding: 1rem;
    }
    .hero-card .d-flex {
      gap: 0.75rem !important;
    }
    .hero-card i {
      font-size: 2rem !important;
    }

    /* Stat cards - compact */
    .stat-card .stat-value {
      font-size: 2rem;
    }
    .stat-card .stat-icon {
      font-size: 2rem;
    }
    .stat-card .stat-label {
      font-size: 0.875rem;
    }
    .stat-card .card-body {
      padding: 1rem;
    }

    /* Chart cards */
    .chart-card .card-header {
      padding: 0.75rem 1rem;
    }
    .chart-card .card-header h5 {
      font-size: 1rem;
    }
    .chart-card .card-body {
      padding: 0.75rem;
    }

    /* Table - horizontal scroll */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .table {
      font-size: 0.875rem;
    }
    .table td, .table th {
      padding: 0.5rem;
      white-space: nowrap;
    }

    /* Footer spacing */
    footer .row > div {
      margin-bottom: 1.5rem;
    }
    footer .row > div:last-child {
      margin-bottom: 0;
    }
  }

  /* Small mobile (< 576px) */
  @media (max-width: 575.98px) {
    .hero-card .card-title {
      font-size: 1.25rem;
    }
    .hero-card .lead {
      font-size: 0.85rem;
    }
    .hero-card i {
      font-size: 1.75rem !important;
    }

    .stat-card .stat-value {
      font-size: 1.75rem;
    }
    .stat-card .stat-icon {
      font-size: 1.5rem;
    }
    .stat-card .stat-label {
      font-size: 0.8rem;
    }

    .chart-card .card-header h5 {
      font-size: 0.9rem;
    }
  }
</style>

<div class="row mb-4">
  <div class="col-md-12">
    <div class="card hero-card">
      <div class="card-body py-4">
        <div class="d-flex align-items-center gap-3 mb-2">
          <i class="bi bi-bar-chart-line" style="font-size: 2.5rem; color: #e67e22;"></i>
          <h1 class="card-title mb-0"><%= title %></h1>
        </div>
        <p class="lead mb-0">Comprehensive analytics and insights from the chainhoist database</p>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4 g-4">
  <div class="col-md-4">
    <div class="card stat-card h-100">
      <div class="card-body text-center py-4">
        <i class="bi bi-database stat-icon"></i>
        <div class="stat-value"><%= report.totalRecords || 0 %></div>
        <div class="stat-label">Total Records</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card h-100">
      <div class="card-body text-center py-4">
        <i class="bi bi-check-circle stat-icon"></i>
        <div class="stat-value"><%= report.processedRecords || 0 %></div>
        <div class="stat-label">Processed Records</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card h-100">
      <div class="card-body text-center py-4">
        <i class="bi bi-building stat-icon"></i>
        <div class="stat-value"><%= Object.keys(report.manufacturerStats || {}).length %></div>
        <div class="stat-label">Manufacturers</div>
      </div>
    </div>
  </div>
</div>

<!-- Data Quality Metrics Section -->
<div class="row mb-4 g-4">
  <div class="col-md-6">
    <div class="card chart-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Data Completeness</h5>
      </div>
      <div class="card-body">
        <%
          const totalRecords = report.totalRecords || 390;
          const qualityGates = report.qualityGates?.gates || [];

          // Calculate completeness from quality gates
          const getCompleteness = (gateName) => {
            const gate = qualityGates.find(g => g.name === gateName);
            if (gate && gate.actual) {
              const pct = parseFloat(gate.actual);
              return isNaN(pct) ? 100 : 100 - pct;
            }
            return 100;
          };

          const metrics = [
            { name: 'Load Capacity', value: getCompleteness('Missing Load Capacity'), color: '#27ae60' },
            { name: 'Lifting Speed', value: getCompleteness('Missing Lifting Speed'), color: '#3498db' },
            { name: 'Motor Power', value: getCompleteness('Missing Motor Power'), color: '#9b59b6' },
            { name: 'Classification', value: getCompleteness('Missing Classification'), color: '#e67e22' },
            { name: 'Source Tracking', value: 100, color: '#1abc9c' }
          ];
        %>
        <% metrics.forEach(function(metric) { %>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="fw-medium"><%= metric.name %></span>
              <span class="badge" style="background: <%= metric.color %>"><%= metric.value.toFixed(1) %>%</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar" role="progressbar" style="width: <%= metric.value %>%; background: <%= metric.color %>;" aria-valuenow="<%= metric.value %>" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card chart-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-shield-check"></i> Quality Gates</h5>
      </div>
      <div class="card-body">
        <% if (report.qualityGates && report.qualityGates.passed) { %>
          <div class="alert alert-success mb-3">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong><%= report.qualityGates.summary || 'All quality gates passed' %></strong>
          </div>
        <% } else { %>
          <div class="alert alert-warning mb-3">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Some quality gates need attention</strong>
          </div>
        <% } %>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Gate</th>
                <th>Threshold</th>
                <th>Actual</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% (report.qualityGates?.gates || []).forEach(function(gate) { %>
                <tr>
                  <td><%= gate.name %></td>
                  <td><code><%= gate.threshold %></code></td>
                  <td><strong><%= gate.actual %></strong></td>
                  <td>
                    <% if (gate.passed) { %>
                      <span class="badge bg-success"><i class="bi bi-check"></i> Pass</span>
                    <% } else { %>
                      <span class="badge bg-danger"><i class="bi bi-x"></i> Fail</span>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4 g-4">
  <div class="col-md-6">
    <div class="card chart-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Capacity Distribution</h5>
      </div>
      <div class="card-body">
        <canvas id="capacityChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card chart-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Classification Distribution</h5>
      </div>
      <div class="card-body">
        <canvas id="classificationChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4 g-4">
  <div class="col-md-6">
    <div class="card chart-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Motor Power Distribution</h5>
      </div>
      <div class="card-body">
        <canvas id="powerChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card chart-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-speedometer2"></i> Lifting Speed Distribution</h5>
      </div>
      <div class="card-body">
        <canvas id="speedChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card chart-card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-building"></i> Manufacturer Statistics</h5>
      </div>
      <div class="card-body p-0 p-md-3">
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th>Manufacturer</th>
                <th>Products</th>
              </tr>
            </thead>
          <tbody>
            <% Object.entries(report.manufacturerStats || {}).forEach(function([manufacturer, count]) { %>
              <tr class="clickable-row" onclick="window.location='/search?manufacturer=<%= encodeURIComponent(manufacturer) %>'" style="cursor: pointer;" role="link" tabindex="0" aria-label="View products from <%= manufacturer %>">
                <td style="color: var(--brand-primary); font-weight: 500;"><%= manufacturer %></td>
                <td><span class="badge" style="background: var(--brand-secondary);"><%= count %></span></td>
              </tr>
            <% }); %>
          </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Brand colors for charts
  const brandColors = ['#1a365d', '#e67e22', '#27ae60', '#3498db', '#9b59b6', '#e74c3c', '#1abc9c', '#f39c12'];

  // Capacity Chart
  const capacityCtx = document.getElementById('capacityChart');
  if (capacityCtx) {
    new Chart(capacityCtx.getContext('2d'), {
      type: 'pie',
      data: {
        labels: <%- JSON.stringify(Object.keys(capacityStats || {})) %>,
        datasets: [{
          data: <%- JSON.stringify(Object.values(capacityStats || {})) %>,
          backgroundColor: brandColors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Classification Chart
  const classCtx = document.getElementById('classificationChart');
  if (classCtx) {
    new Chart(classCtx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: <%- JSON.stringify(Object.keys(report.classificationDistribution || {})) %>,
        datasets: [{
          data: <%- JSON.stringify(Object.values(report.classificationDistribution || {})) %>,
          backgroundColor: brandColors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Power Chart
  const powerCtx = document.getElementById('powerChart');
  if (powerCtx) {
    new Chart(powerCtx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: <%- JSON.stringify(Object.keys(powerStats || {})) %>,
        datasets: [{
          label: 'Count',
          data: <%- JSON.stringify(Object.values(powerStats || {})) %>,
          backgroundColor: '#1a365d'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Speed Chart
  const speedCtx = document.getElementById('speedChart');
  if (speedCtx) {
    new Chart(speedCtx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: <%- JSON.stringify(Object.keys(speedStats || {})) %>,
        datasets: [{
          label: 'Count',
          data: <%- JSON.stringify(Object.values(speedStats || {})) %>,
          backgroundColor: '#e67e22'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Keyboard support for clickable rows
  document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        row.click();
      }
    });
  });
});
</script>

<%- include('components/toast') %>

<%- include('footer') %>
